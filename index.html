<!DOCTYPE html>

<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <script src="https://kit.fontawesome.com/1205482781.js"></script>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <title>Home</title>
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <!--SIDEBAR VERTICAL-->
      <div class="col-2">
        <nav class="navbar navbar-expand-md navbar-white bg-navbar fixed-left justify-content-between" id="sidebar">
          <div class="nav-container">
            <a class="navbar-brand" href="index.html">
              <img src="logo/Spotify_Logo.png" alt="Spotify_Logo" width="131" height="40" />
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup"
              aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
              <div class="navbar-nav">
                <ul>
                  <li>
                    <a class="nav-item nav-link" href="index.html"><i class="fas fa-home fa-lg"></i>&nbsp; Home
                    </a>
                  </li>
                  <li>
                    <a class="nav-item nav-link" href="#"><i class="fas fa-book-open fa-lg"></i>&nbsp; Your
                      Library</a>
                  </li>
                  <li>
                    <div class="input-group mt-3">
                      <input type="text" class="form-control mb-2" id="searchField" placeholder="Search"
                        aria-label="Search" aria-describedby="basic-addon2" onkeyup="handleSearchQuery(event)" />
                      <div class="input-group-append" style="margin-bottom: 4%">
                        <button class="btn btn-outline-secondary btn-sm" type="button" id="button-addon1"
                          onclick="search()">
                          GO
                        </button>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="nav-btn">
            <button class="btn signup-btn" type="button">Sign Up</button>
            <button class="btn login-btn" type="button">Login</button>
            <a href="#">Cookie Policy</a> |
            <a href="#"> Privacy</a>
          </div>
        </nav>
      </div>
      <!--END SIDEBAR VERTICAL-->

      <!--MAIN-->
      <div class="col-12 col-md-9 offset-md-3 mainPage">
        <div class="row justify-content-center">
          <div class="col-9 col-lg-11 mainLinks d-none d-md-flex">
            <a id="Rock" href="#">ROCK</a>
            <a id="Pop" href="#">POP</a>
            <a id="Hip Hop" href="#">HIP HOP</a>
            <a href="#">NEW RELEASES</a>
            <a href="#">DISCOVER</a>
          </div>
        </div>
        <div class="row">
          <div class="col-10">
            <div id="searchResults" style="display: none">
              <h2>Search Results</h2>
              <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 imgLinks py-3"></div>
            </div>
          </div>
        </div>
        <div class="row justify-content-center">
          <div class="col-10">
            <div id="results">
              <h2 class="pl-3 text-white d-inline-block"></h2>
              <div class="spinner-border text-primary d-none" role="status">
                <span class="sr-only">Loading...</span>
              </div>
              <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 imgLinks py-3">
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
                <div class="col text-center">
                  <img class="img-fluid" src="http://placehold.it/300x300" alt="img placeholder" />
                  <p>
                    <a href="/album_page.html">Album Title</a>
                    <br />
                    <a href="/artist_page.html">Artist Name</a>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!--END MAIN-->

  <!--NAVBAR FLEX-BOTTOM-->
  <div class="player container-fluid fixed-bottom bg-container pt-1">
    <div class="row flex-nowrap justify-content-between playBar py-3">
      <div class="col-auto">
        <div class="playerArtistInfo d-flex">
          <img />
          <div class="d-flex flex-column pl-2">
            <h6></h6>
            <p></p>
          </div>
        </div>
      </div>
      <div class="col-6">
        <div class="playerControls w-50 d-flex justify-content-between">
          <a href="#">
            <img src="playerbuttons/Shuffle.png" alt="shuffle" />
          </a>
          <a href="#">
            <img src="playerbuttons/Previous.png" alt="previous" />
          </a>
          <a href="#">
            <img src="playerbuttons/Play.png" alt="play" />
          </a>
          <a href="#">
            <img src="playerbuttons/Next.png" alt="next" />
          </a>
          <a href="#">
            <img src="playerbuttons/Repeat.png" alt="repeat" />
          </a>
        </div>
        <div class="progressContainer d-flex align-items-center">
          <span class="currentTime">00:00</span>
          <div class="progress w-100">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
              <audio></audio>
            </div>
          </div>
          <span class="duration">00:00</span>
        </div>
      </div>
      <div class="col-auto mr-3">
        <div class="playerVolume">
          <i class="fa fa-volume-up"></i>
          <input type="range" value="50" />
        </div>
      </div>
    </div>
  </div>
  <!--END NAVBAR BOTTOM-->

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
    crossorigin="anonymous"></script>

  <script>

    let rockArtists = [
      "queen",
      "u2",
      "thepolice",
      "eagles",
      "thedoors",
      "oasis",
      "thewho",
      "bonjovi",
    ];

    let popArtists = [
      "maroon5",
      "coldplay",
      "onerepublic",
      "jamesblunt",
      "katyperry",
      "arianagrande",
    ];

    let hipHopArtists = [
      "eminem",
      "snoopdogg",
      "lilwayne",
      "drake",
      "kanyewest",
    ];

    // ### Player functionality ###
    const audio = document.getElementsByTagName("audio")[0] // grabbing audio element
    const playBtn = document.querySelector("img[alt='play']") // grabbing play button element

    const setPlayerSong = (song) => { // gets called by the onclick onto the column of the element
      // audio.src = song.preview
      playBtn.src = "./playerbuttons/Pause.png" // we need to change the icon state since the song will be playing when this function runs

      localStorage.setItem("songId", song.id) // setting the clicked song id into the localStorage (needed to retrieve the last chosen song upon fetching -below-)
      setPlayerInfos(song) // this function will populate the information of the player (img, title, album, son duration etc)
      audio.play() // triggers the audio to play (audio tag received the src from within setPlayerInfos)
    }

    const setPlayerInfos = (song) => {

      // grabbing elements
      const playerArtistInfo = document.querySelector(".playerArtistInfo")

      const img = playerArtistInfo.querySelector("img")
      const songTitle = playerArtistInfo.querySelector("h6")
      const songAlbum = playerArtistInfo.querySelector("p")

      // applying song info to the player
      img.src = song.album.cover_small;
      img.classList.add("img-fluid")
      songTitle.innerText = song.title_short
      songAlbum.innerText = song.album.title

      // resets current time
      const currTime = document.querySelector(".player .currentTime")
      currTime.innerText = "00:00"

      // adds song duration
      const duration = document.querySelector(".player .duration")
      const minutes = "0" + Math.floor(song.duration / 60)
      const seconds = "0" + Math.floor(song.duration % 60)

      duration.innerText = minutes.slice(-2) + ":" + seconds.slice(-2)

      // that's when the audio tag receives the source and it's ready to play()
      audio.src = song.preview
    }

    const handleChangeVolume = (event) => { // function triggered by the onchange event of the volume's range input 
      const rangeValue = event.target.value
      const volume = rangeValue / 100

      audio.volume = volume // affetcs the audio element's volume

      localStorage.setItem("prevVolume", rangeValue) // set chosen volume value in localStorage for later use
    }

    // manages the movement of the progress bar, gets called by the audio.ontimeupdate
    const handleProgressBarUpdate = (ended) => {
      const progressBar = document.querySelector(".progress-bar") // grabs progress bar div
      const percentage = (audio.currentTime / audio.duration) * 100 // computes percentage value

      progressBar.style.width = percentage.toString() + "%" // applies the percentace as width of the progress bar

      const currTime = document.querySelector(".player .currentTime")

      const minutes = "0" + Math.floor(audio.currentTime / 60)
      const seconds = "0" + Math.floor(audio.currentTime)

      currTime.innerText = minutes.slice(-2) + ":" + seconds.slice(-2) // updates current time
    }

    const handleProgressBarClick = (event) => {
      // fired after clicking the progress-bar

      const elem = event.currentTarget.firstElementChild;
      const percentage = parseInt((event.offsetX / event.currentTarget.clientWidth) * 100);
      // calculates where you clicked in relation to the total width of the div (clientWidth)

      elem.style.width = percentage.toString() + "%"; // updates the bar with the new position
      elem.setAttribute("aria-valuenow", percentage.toString());

      audio.currentTime = (percentage / 100) * audio.duration; // moves song time depending on where the progress-bar was clicked
    };

    const handlePlay = () => {
      if (audio.paused) { // when audio is not playing
        playBtn.src = "./playerbuttons/Pause.png"
        audio.play()
      } else { // when audio is already playing
        playBtn.src = "./playerbuttons/Play.png"
        audio.pause()
      }
    }

    window.addEventListener("DOMContentLoaded", () => {

      audio.ontimeupdate = () => handleProgressBarUpdate() // triggered by the song progressing, on every second or so
      // audio.addEventListener("timeupdate", () => handleProgressBarUpdate())
      audio.onended = () => handleProgressBarUpdate(true); // triggered when the song ends, passing true as a parameter to reset the progress bar at the end

      const progressBar = document.querySelector(".progress"); // grabs the .progress container
      progressBar.onclick = (event) => handleProgressBarClick(event); // attaches an onclick event on the progress bar to fire handleProgressBarClick upon clicking

      playBtn.onclick = () => handlePlay() // click on the play button

      // input.onclick = () => 
      // input.addEventListener("click", () => {})

      const volumeRange = document.querySelector("input[type='range'") // volume input
      volumeRange.onchange = () => handleChangeVolume() // triggers a function when changed
      const storageVolume = localStorage.getItem("prevVolume") // gets the volume from the localStorage

      if (storageVolume) { // if a previous volume is found
        volumeRange.value = storageVolume // changes the position of the range input
        audio.volume = storageVolume / 100 // applies the previous volume when the page loads
      }

    })

    // ### End of player functionality

    const isLoading = (loading) => {

      const spinner = document.querySelector(".spinner-border")

      if (loading) {
        spinner.classList.remove("d-none")
      } else {
        spinner.classList.add("d-none")
      }
    }

    const albumCard = (song) => `
                    <img
                      class="img-fluid"
                      src=${song.album.cover_medium}
                      alt="img placeholder"
                    />
                    <h6>${song.title}</h6>
                    <p>
                      <a href="/album_page.html?albumId=${song.album.id}">${song.album.title}</a>
                      <br />
                      <a href="/artist_page.html?artistId=${song.artist.id}">${song.artist.name}</a>
                    </p>
                  `

    const searchHistory = localStorage.getItem("q")
    console.log(searchHistory)

    // let query = searchHistory ? searchHistory : "daft punk"
    let query = searchHistory ?? "daft punk"

    const handleSearchQuery = (event) => {
      // console.log("EVENT", event)

      query = event.target.value

      localStorage.setItem("q", event.target.value)

      if (event.key === "Enter" && query.length > 3) {
        search()
      }
    }

    const search = (q = query) => {
      isLoading(true)

      fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=" + q, {
        "method": "GET",
        // "headers": {
        //   "x-rapidapi-host": "deezerdevs-deezer.p.rapidapi.com",
        //   "x-rapidapi-key": "44990dcd76msh9e7711544b7bcbbp18140cjsnaed06a042dae"
        // }
      })
        .then(response => response.json())
        .then(({ data }) => {
          // console.log(body)

          const songsArray = data

          document.querySelector("#results > h2").innerText = query;

          const row = document.querySelector("#results > .row")
          row.innerHTML = ""

          songsArray.forEach(song => {
            console.log("SONG", song)

            const col = document.createElement("div")
            col.className = "col text-center"
            col.innerHTML = albumCard(song)

            col.onclick = () => setPlayerSong(song) // every col will trigger the audio to play

            row.appendChild(col)

          })

          const storageSongId = localStorage.getItem("songId")
          const prevSong = songsArray.find((song) => song.id === parseInt(storageSongId))
          // getting previous song by checking the id from the localStorage of the last selected song 

          if (storageSongId && prevSong) { // if there's a previous song
            console.log(prevSong)
            setPlayerInfos(prevSong) // use that song and pre-fill the player with that
          } else {
            setPlayerInfos(songsArray[0]) // otherwise use any valid song arbitrarily selected by you
          }

          isLoading(false)
        })
        .catch(err => {
          console.error(err);
        });
    }

    const getSongsFromArr = (arr, secTitle) => {
      isLoading(true)

      // console.log(arr)

      const row = document.querySelector("#results > .row")

      const arrOfPromises = arr.map(artist => fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=" + artist).then(response => response.json()))

      console.log(arrOfPromises)
      // [response.json(),response.json(),response.json(),response.json()]
      // [Promise, Promise, Promise, Promise, Promise, Promise, Promise, Promise].then(finished => alert(finished))


      // const reducer = (acc, current) => acc.concat(...current)
      const reducer = (acc, current) => [...acc, ...current.slice(0, 4)]

      Promise.all(arrOfPromises)
        .then(arrOfData => {
          console.log("PROMISE ALL RESULTS: ", arrOfData)

          row.innerHTML = ""
          document.querySelector("#results > h2").innerText = secTitle

          arrOfData
            // [{data: Array(25)}, {data: [.....]}, {data: [.....]}, {data: [.....]}]
            .map(obj => obj.data)
            // newArray [[{ songs }, { songs }, { songs }, { songs }], [{ songs }, { songs }, { songs }, { songs }], .....]
            .reduce(reducer, [])
            // newArray [{ songs }, { songs }, { songs }, { songs }, { songs }, { songs }, ....]
            .forEach(song => {
              row.innerHTML += albumCard(song)
            })

          isLoading(false)
        })
    }


    window.onload = () => {
      search()

      // document.getElementById("Rock").addEventListener("click",  () => )
      document.getElementById("Rock").onclick = () => getSongsFromArr(rockArtists, "Rock")
      document.getElementById("Pop").onclick = () => getSongsFromArr(popArtists, "Pop")
      document.getElementById("Hip Hop").onclick = () => getSongsFromArr(hipHopArtists, "Hip Hop")
    };




    const artists = ["mumford", "ac dc", "greta van fleet"]

    const mumford = () => {
      return fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=mumford").then(resp => resp.json())
    }
    const ledZeppelin = () => {
      return fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=ledzeppelin").then(resp => resp.json())
    }
    const acdc = () => {
      return fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=ac/dc").then(resp => resp.json())
    }

    // mumford().then(jsonParsed => console.log(jsonParsed)).catch()
    // ledZeppelin().then(jsonParsed => console.log(jsonParsed)).catch()
    // acdc().then(jsonParsed => console.log(jsonParsed)).catch()

    Promise.all([mumford(), ledZeppelin(), acdc()]).then(arrOfResps => console.log(arrOfResps)).catch(err => console.log(err))
    // Promise.all([Promise, Promise, Promise]).then().catch()




    const loadConcurrentUncontrolled = () => {
      let total = artists.length

      artists.forEach(artist => {
        fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=" + artist)
          .then(resp => resp.json())
          .then(songs => {
            console.log("Songs from ", artist, songs)
            total--
            if (total === 0) { console.log("this fetch was the last one " + artist) }
          })
      })
    }
    // Parallel approach 
    //F1 -------
    //F2 ---------------
    //F3 ----




    const loadSerial = () => {
      const result = []
      fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=" + artists[0])
        .then(resp => resp.json())
        .then(songs => {
          result.push(...songs.data)
          return fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=" + artists[1])
        })
        .then(resp => resp.json())
        .then(songs => {
          result.push(...songs.data)
          return fetch("https://striveschool-api.herokuapp.com/api/deezer/search?q=" + artists[2])
        })
        .then(resp => resp.json())
        .then(songs => {
          result.push(...songs.data)

          console.log(result)
          return result
        })

      console.log("HERE")
    }
    //Serial approach
    //F1 -------
    //F2        ---------------
    //F3                       -------

  </script>
</body>

</html>